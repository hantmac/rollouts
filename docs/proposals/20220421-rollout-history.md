---
title: Proposal Template

authors:
- "@hantmac"


  reviewers:
- "@FillZpp"
- "@furykerry"


  creation-date: 2022-04-24

  last-updated: 2022-04-24

status: implementable

---

# RolloutHistory

- Record the information such as rollout status, pod names, pod ips, rollout strategy... when user do a rollout action.

## Table of Contents

A table of contents is helpful for quickly jumping to sections of a proposal and for highlighting
any additional information provided beyond the standard proposal template.
[Tools for generating](https://github.com/ekalinin/github-markdown-toc) a table of contents from markdown are available.

- [RolloutHistory](#RolloutHistory)
    - [Table of Contents](#table-of-contents)
    - [Motivation](#motivation)
    - [Proposal](#proposal)
        - [User Stories](#user-stories)
            - [Story 1](#story-1)
        - [Implementation Details/Notes/Constraints](#implementation-detailsnotesconstraints)
        - [Risks and Mitigations](#risks-and-mitigations)
    - [Implementation History](#implementation-history)

## Motivation

From the design doc of rollouts, we know that the rollouts resource is bound to a deployment or cloneset, which is a one to one mode.
When users finish some rollout actions, they can not find some information in the past few actions.
And a history record of rollout is very useful for rollout tracing. 
So we should record the information such as pod names, pod ips, rollout strategy... when user do a rollout action.

It is useful for some user scenarios, such as:

1. Help users to know what happened in the past few rollout actions.

## Proposal

Define a CRD named `RolloutHistory` (short name `RH`):

```yaml
apiVersion: apps.kruise.io/v1alpha1
kind: RolloutHistory
metadata:
  generateName: rollout-history-
  namespace: namespace
  name: rollout-history-hash
  creationTimestamp: "2022-04-21T03:30:27Z"
  resourceVersion: "2655617704"
  ownerReferences:
    - apiVersion: rollouts.kruise.io/v1alpha1
      blockOwnerDeletion: true
      controller: true
      kind: Rollout
      name: rollout-tmp
      uid: 961d4a07-4efa-4a10-9820-1543a7dfe099
spec:
  workLoadName: cloneSet-demo
  releaseType: batchRelease # current support batchRelease and rolloutRelease
  strategy:
    type: canary
    canary:
      # canary published, e.g. 20%, 40%, 60% ...
      steps:
        # routing 5% traffics to the new version
        - weight: 5
          # Manual confirmation of the release of the remaining pods
          pause: {}
          # optional, The first step of released replicas. If not set, the default is to use 'weight', as shown above is 5%.
          replicas: 20%
      trafficRoutings:
        # echoserver service name
        - service: echoserver
          # nginx ingress
          type: nginx
          # echoserver ingress name
          ingress:
            name: echoserver
```

1. When user start a rollout process, a RolloutHistory is generated, it's owner is the kruise-rollout resource.
2. The `spec.stragety` records the strategy of rollout in that time.
3. `spec.releaseType` means kruise support `batchRelease` and `rolloutRelease` currently.
4. `spec.workLoadName` means the workload name the rollout release.

### Status

Status of `RH` looks like this:

```yaml
status:
  stableRevision: "sssss"
  pods:
  - ip: 10.1.1.1
    node: 192.1.1.1
    name: pod-1
  - ip: 10.2.2.2
    node: 192.2.2.2
    name: pod-2
  conditions:
  - type: Initialing
    status: True
    lastUpdateTime: "2021-03-22T11:53:48Z"
    lastTransitionTime: "2021-03-22T11:53:48Z"
    reason: "Initializing"
    message: "Initializing"
  - type: Progressing
    status: True
    lastUpdateTime: "2021-03-22T11:53:48Z"
    lastTransitionTime: "2021-03-22T11:53:48Z"
    reason: "Progressing"
    message: "Progressing"
  startTime: "2021-03-22T11:53:48Z"
  updateTime: "2021-03-22T11:53:48Z"
  completionTime: "2021-03-22T11:53:48Z"
  message: "rollout completed"
  phase: Completed
```

The `status.pods` include the info that generated by all the new pods in the rollout process.

The `status.phase` can be:
```go
        // RolloutPhaseInitial indicates a rollout is Initial
	RolloutPhaseInitial RolloutPhase = "Initial"
	// RolloutPhaseHealthy indicates a rollout is healthy
	RolloutPhaseHealthy RolloutPhase = "Healthy"
	// RolloutPhasePreparing indicates a rollout is preparing for next progress.
	RolloutPhasePreparing RolloutPhase = "Preparing"
	// RolloutPhaseProgressing indicates a rollout is not yet healthy but still making progress towards a healthy state
	RolloutPhaseProgressing RolloutPhase = "Progressing"
	// RolloutPhaseFinalizing indicates a rollout is finalizing
	RolloutPhaseFinalizing RolloutPhase = "Finalizing"
	// RolloutPhaseTerminating indicates a rollout is terminated
	RolloutPhaseTerminating RolloutPhase = "Terminating"
	// RolloutPhaseCompleted indicates a rollout is completed
	RolloutPhaseCompleted RolloutPhase = "Completed"
	// RolloutPhaseCancelled indicates a rollout is cancelled
	RolloutPhaseCancelled RolloutPhase = "Cancelled"
```

**When the rollout process has completed, the `status.conditions` record all the changes in this release.**

### User Stories

#### Story 1

Users want to know what happened in the past few rollout actions, for example, the strategy in that rollout(the Rollout strategy has been changed since last release),
the detail conditions and so on.

Related [Issue](https://github.com/openkruise/rollouts/issues/10).

### Requirements

`RolloutHistory` relies on `Rollout` and `BatchRelease` resources. Also it need to watch the event of workload.

### Implementation Details/Notes/Constraints

When users create a `rollout`, the rollout webhook will create a `RolloutHistory` resource according to the content of `rollout` or `batchRelease`. 
Then set the ownerReference for `RolloutHistory`.

The controller of `RolloutHistory` will record some information until the `rollout` completed.

### Risks and Mitigations

- Currently, we don't want to listwatch pods in kruise-rollout, so how to record the pod names will be a problem.
- There are many kind of release type, such as `canary rollout`,`blue-green rollout`, `batch release` and so on, the status of `RH` may not cover all the status information in release types.

## Implementation History

- [ ] 24/04/2022: Proposal submission
